## 介绍

*    INNFOS CAN SDK STM32版 提供了友好的用户接口，包括了STM32F429单片机与多个INNFOS执行器进行通信的功能，可对多个执行器发送指令或者获取执行器状态和参数信息。

*    建议初次接触API的用户优先阅读工程文件中的 `readme` 说明文件。

----

## 下载 SDK

访问[INNFOS_CAN_SDK_STM32](https://github.com/innfos/INNFOS_CAN_SDK_STM32.git)获取MDK工程文件

----

## 文件结构

*  `BSP`：STM32外设底层驱动文件
*  `CORE`：Cortex-M4 内核控制文件与STM32启动文件
*  `FWLIB`：STM32标准外设驱动库
*  `MDK`：MDK工程文件
*  `SCA`：INNFOS CAN 协议驱动文件以及应用实例代码
*  `SYSTEM`：STM32编程环境常用接口
*  `USER`：存放main.c等

*  `Keilkilll.bat`：清除编译产生的中间文件
*  readme.txt`：相关说明

### SCA文件目录说明

*  `SCA_Protocol.c/h`：INNFOS CAN 通信协议层，该协议层完成了数据帧封装，解包等步骤，使用CAN1端口进行数据收发；
*  `SCA_API.c/h`：通信协议层的封装，包含了所有参数的读写API；
*  `SCA_APP.c/h`：演示程序；

----

## 示例代码编译运行

*  PC安装Keil MDK软件，工程所用版本为V5.21.1.0。所用单片机型号为`STM32F429IGT6`。

*  打开MDK文件夹下的SCA_Controller.uvprojx文件，出现MDK的使用界面以及main.c代码：

*  此DEMO中使用的执行器ID为0x03，在 SCA_APP.c 文件中有多处语句使用了该ID，请根据实际使用的执行器求修改所有对应的ID数值。

*  确保单片机通过`ST-LINK`或`J-LINK`等调试工具连接至PC，并能够正常工作。点击全部编译按钮，无错通过后点击下载按钮下载至单片机。

*  连接完成后，将单片机的`串口1（PA9 PA10）`通过USB转串口工具连接至PC。打开虚拟串口终端软件，将波特率设为115200，接收数据以ASC码形式显示，以16进制形式发送数据。发送数字6打印帮助信息。

*  根据提示信息，先初始化执行器，依次发送指令，结合`SCA_APP.c`下的代码观察执行器的动作变化。

-----

## 进阶使用

### 驱动架构

* `INNFOS CAN SDK STM32`版将驱动程序进行了分层处理。

*  在`SCA_Protocol.c/h`下调用了`STM32 CAN`控制器收发数据的接口，提供了5类写入命令与4类读取命令的API。在这些API中会针对不同命令对收发的数据进行打包或解包。头文件中包含了所有指令的宏定义，通信错误类型，以及用来保存每个执行器参数信息的信息句柄结构体定义。

*  在`SCA_API.c/h`下提供了所有参数的读写功能，用户可直接调用该层的API。该层代码将指令与收发数据进行组合，并调用相应的读写API实现数据收发。（某些特殊的API直接调用了CAN收发函数，移植时请留意。）大部分API都带有返回值，返回该次通信的结果，返回SCA_NoError为操作成功。详细定义在Protocol.h下。头文件中包含了执行器6种操作模式和2种状态的宏定义，以及参数配置的宏定义。

*  本例程采用的是阻塞式的通信方式，即发出数据后以查询方式等待接收，若超时则退出等待并返回错误代码。可以自行修改为中断接收，数据解析格式参见协议层读写命令。

### 参数配置

*  在使用或移植时，需先配置系统参数，相关宏定义在`SCA_API.h`下。由于本例程采用的是阻塞式的通信方式，移植后需要根据CPU速度调整超时时间，其中开关机时间较长，其他参数返回时间较短。

### API调用

*  所有的`API`以`ID`来区分总线上的执行器，如读写位置的函数。写位置时，传入要执行的执行器ID，与实际位置值（±127.0R）；读位置时，只传入要读取的执行器ID即可将当前位置值读进对应的信息句柄中。大部分API带有返回值，返回本次数据通信的结果，当返回`SCA_NoError（0）`时，该指令执行成功，返回其他参见`SCA_Protocol.h`下的错误类型定义。

*  所有的信息句柄会以结构体数组的形式进行初始化定义，定义的长度为`SCA_NUM_USE`，与实际使用的SCA数量保持一致。所有以ID区分执行器的API中，会有以ID查找信息句柄的过程，调用 `SCA_Handler_t* getInstance(uint8_t id)`函数。该函数会返回指定ID的信息句柄地址，若ID不存在则返回NULL。用户想要获取每个执行器的参数信息，则定义个一个 `SCA_Handler_t`类型的指针，然后用 `getInstance(uint8_t id)` 函数获取对应ID的地址，用指针查看对应的参数即可。同时，该类型的指针也可以传入`Fast`型函数中，快速的执行指令，进而省略查找信息句柄的过程，当使用的SCA数量较多时，推荐使用此种类型的函数。

*  当修改完执行器的参数时，需要使用`saveAllParams(uint8_t id)`函数将参数永久保存，否则下次开机后执行器内依然为未修改的参数。

*  在初始化`SCA`时，用户可使用`lookupActuators()`函数让程序自动在总线上轮询（同时得到ID和序列号），或者自己更改句柄中的ID和序列号（设置ID用）来手动完成初始化。

----



